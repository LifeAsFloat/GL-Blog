<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">文章详情 - GL-Blog</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.8;
      color: #333;
      background: #0a0a0a;
      position: relative;
      overflow-x: hidden;
    }

    /* 背景图片 */
    .bg-image {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
      opacity: 0.85;
    }

    .bg-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.6) 100%);
      z-index: 1;
    }

    /* 顶部导航 */
    .top-nav {
      position: fixed;
      top: 2em;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 40px);
      max-width: 860px;
      z-index: 99;
      display: flex;
      gap: 12px;
    }

    .nav-button {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      color: #000;
      text-decoration: none;
      padding: 12px 24px;
      border-radius: 0.75rem;
      border: 0.5px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .nav-button:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 1);
    }

    /* 主内容 */
    .container {
      position: relative;
      z-index: 2;
      max-width: 900px;
      margin: 0 auto;
      padding: 140px 20px 60px;
    }

    .post-header {
      background: rgba(255, 255, 255, 1);
      padding: 50px;
      border-radius: 16px;
      margin-bottom: 30px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.15),
        0 2px 8px rgba(0, 0, 0, 0.1);
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .post-title {
      font-size: 2.5em;
      margin-bottom: 20px;
      color: #1a1a1a;
      font-weight: 700;
      line-height: 1.3;
    }

    .post-meta {
      color: #666;
      font-size: 1em;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .post-date::before {
      content: "";
    }

    .tag {
      display: inline-block;
      background: rgba(0, 0, 0, 0.08);
      color: #333;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.9em;
      font-weight: 500;
    }

    .post-content {
      background: rgba(255, 255, 255, 1);
      padding: 50px;
      border-radius: 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.15),
        0 2px 8px rgba(0, 0, 0, 0.1);
      font-size: 1.1em;
      line-height: 1.9;
      animation: fadeInUp 0.6s ease-out 0.1s backwards;
    }

    .post-content h1,
    .post-content h2,
    .post-content h3,
    .post-content h4,
    .post-content h5,
    .post-content h6 {
      margin-top: 1.5em;
      margin-bottom: 0.8em;
      color: #1a1a1a;
      font-weight: 600;
    }

    .post-content h1 { font-size: 2em; }
    .post-content h2 { font-size: 1.7em; }
    .post-content h3 { font-size: 1.4em; }

    .post-content p {
      margin-bottom: 1.2em;
    }

    .post-content img {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .post-content a {
      color: #0066cc;
      text-decoration: none;
      border-bottom: 1px solid #0066cc;
      transition: all 0.3s;
    }

    .post-content a:hover {
      color: #0052a3;
      border-bottom-color: #0052a3;
    }

    .post-content code {
      background: rgba(0, 0, 0, 0.05);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .post-content pre {
      background: #1a1b26;
      padding: 50px 20px 20px;
      border-radius: 12px;
      overflow-x: auto;
      margin: 20px 0;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    /* 现代化滚动条 */
    .post-content pre::-webkit-scrollbar {
      height: 8px;
    }

    .post-content pre::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    .post-content pre::-webkit-scrollbar-thumb {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .post-content pre::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(90deg, #764ba2 0%, #667eea 100%);
    }

    /* 复制按钮 */
    .copy-code-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .copy-code-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .copy-code-btn.copied {
      background: rgba(76, 175, 80, 0.3);
      border-color: rgba(76, 175, 80, 0.5);
    }

    .post-content pre code {
      background: none;
      padding: 0;
      color: #a9b1d6;
    }

    .post-content blockquote {
      border-left: 4px solid #0066cc;
      padding-left: 20px;
      margin: 20px 0;
      color: #555;
      font-style: italic;
      background: rgba(0, 102, 204, 0.05);
      padding: 15px 20px;
      border-radius: 0 8px 8px 0;
    }

    .post-content ul,
    .post-content ol {
      margin-left: 30px;
      margin-bottom: 1.2em;
    }

    .post-content li {
      margin-bottom: 0.5em;
    }

    .post-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    .post-content th,
    .post-content td {
      border: 1px solid #e0e0e0;
      padding: 12px;
      text-align: left;
    }

    .post-content th {
      background: rgba(0, 0, 0, 0.05);
      font-weight: 600;
    }

    .loading,
    .error {
      text-align: center;
      padding: 80px 20px;
      font-size: 1.2em;
      color: white;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* 提示样式 */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      color: #333;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      font-weight: 500;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .toast.toast-success {
      border-left: 4px solid #28a745;
    }
    
    .toast.toast-error {
      border-left: 4px solid #dc3545;
    }

    @media (max-width: 768px) {
      .top-nav {
        left: 15px;
        transform: none;
        width: calc(100% - 30px);
        top: 1em;
        gap: 8px;
        justify-content: flex-start;
      }

      .nav-button {
        padding: 10px 18px;
        font-size: 0.9rem;
        border-radius: 12px;
      }

      .container {
        padding: 100px 15px 40px;
      }

      .post-header,
      .post-content {
        padding: 30px 25px;
        border-radius: 16px;
      }

      .post-title {
        font-size: 1.9rem;
        line-height: 1.3;
      }

      .post-content {
        font-size: 1rem;
        line-height: 1.8;
      }
      
      .post-content h1 { font-size: 1.8em; }
      .post-content h2 { font-size: 1.5em; }
      .post-content h3 { font-size: 1.3em; }
      
      .post-content pre {
        margin: 20px -10px;
        border-radius: 12px;
      }
      
      .toast {
        top: 10px;
        right: 10px;
        max-width: calc(100% - 20px);
        left: 10px;
        transform: translateY(-100%);
      }
      
      .toast.show {
        transform: translateY(0);
      }
    }
    
    @media (max-width: 480px) {
      .top-nav {
        left: 12px;
        transform: none;
        width: calc(100% - 24px);
        flex-wrap: wrap;
        justify-content: flex-start;
      }
      
      .nav-button {
        padding: 8px 16px;
        font-size: 0.85rem;
      }
      
      .container {
        padding: 85px 12px 30px;
      }
      
      .post-header,
      .post-content {
        padding: 25px 20px;
        border-radius: 14px;
      }
      
      .post-title {
        font-size: 1.6rem;
      }
      
      .post-content {
        font-size: 0.95rem;
      }
      
      .post-content h1 { font-size: 1.6em; }
      .post-content h2 { font-size: 1.4em; }
      .post-content h3 { font-size: 1.2em; }
      
      .post-content pre {
        font-size: 0.85rem;
      }
    }
    
    /* 移除所有按钮和可点击元素的焦点轮廓 */
    button, a, input, select, textarea, [role="button"], [tabindex], .nav-button, .copy-btn {
      outline: none !important;
      -webkit-tap-highlight-color: transparent !important;
    }
    
    button:focus, a:focus, input:focus, select:focus, textarea:focus, [role="button"]:focus, [tabindex]:focus, .nav-button:focus, .copy-btn:focus {
      outline: none !important;
      box-shadow: none !important;
    }
  </style>
</head>
<body>
  <!-- 背景图片 -->
  <img src="/BG/BG.png" alt="Background" class="bg-image" id="bgImage">
  <div class="bg-overlay"></div>

  <!-- 顶部导航 -->
  <div class="top-nav">
    <a href="/" class="nav-button">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
      <span>返回首页</span>
    </a>
    <a href="/admin" class="nav-button">
      <span>管理后台</span>
    </a>
  </div>

  <!-- 主内容 -->
  <div class="container">
    <div id="postContainer">
      <div class="loading">加载中...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>

  <script>
    // 配置 marked
    marked.setOptions({
      breaks: true,
      gfm: true
    });

    async function loadPost() {
      const slug = window.location.pathname.split('/').pop();
      
      try {
        const response = await fetch(`/api/post/${slug}`);
        
        if (!response.ok) {
          throw new Error('文章不存在');
        }
        
        const post = await response.json();
        
        // 更新页面标题
        document.getElementById('pageTitle').textContent = `${post.title} - GL-Blog`;
        
        // 渲染文章
        const container = document.getElementById('postContainer');
        
        // 解析 Markdown
        let htmlContent = marked.parse(post.content);
        
        // 修复图片路径：将相对路径转换为绝对路径
        htmlContent = htmlContent.replace(/src="(?!http|\/)(.*?)"/g, 'src="/uploads/$1"');
        
        container.innerHTML = `
          <div class="post-header">
            <h1 class="post-title">${escapeHtml(post.title)}</h1>
            <div class="post-meta">
              <span class="post-date">${formatDate(post.date)}</span>
              ${post.category ? `<span class="tag">${escapeHtml(post.category)}</span>` : ''}
              ${post.tags && post.tags.length > 0 ? post.tags.map(tag => 
                `<span class="tag">${escapeHtml(tag)}</span>`
              ).join('') : ''}
            </div>
          </div>
          <div class="post-content">
            ${htmlContent}
          </div>
        `;

        // 高亮代码块并添加复制按钮
        if (typeof hljs !== 'undefined') {
          document.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });
        }
        
        // 为每个代码块添加复制按钮
        document.querySelectorAll('pre').forEach((pre) => {
          const button = document.createElement('button');
          button.className = 'copy-code-btn';
          button.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span>复制</span>
          `;
          
          button.addEventListener('click', async () => {
            const code = pre.querySelector('code');
            const text = code ? code.textContent : pre.textContent;
            
            try {
              // 优先使用 Clipboard API
              if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
              } else {
                // 备用方案：使用传统的 execCommand
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                textArea.remove();
              }
              
              button.classList.add('copied');
              button.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span>已复制</span>
              `;
              
              // 显示成功提示
              showCopySuccess();
              
              setTimeout(() => {
                button.classList.remove('copied');
                button.innerHTML = `
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                  <span>复制</span>
                `;
              }, 2000);
            } catch (err) {
              console.error('复制失败:', err);
              showCopyError();
            }
          });
          
          pre.appendChild(button);
        });
        
      } catch (error) {
        document.getElementById('postContainer').innerHTML = 
          '<div class="error">文章不存在或加载失败<br><a href="/" style="color: #fff; text-decoration: underline;">返回首页</a></div>';
        console.error('加载文章失败:', error);
      }
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // 显示复制成功提示
    function showCopySuccess() {
      showToast('复制成功', 'success');
    }
    
    // 显示复制失败提示
    function showCopyError() {
      showToast('复制失败', 'error');
    }
    
    // 通用提示函数
    function showToast(message, type = 'success') {
      // 移除已存在的提示
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }
      
      // 创建提示元素
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      
      // 添加到页面
      document.body.appendChild(toast);
      
      // 显示动画
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // 自动隐藏
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, 2000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 加载自定义背景和站点设置
    async function loadSettings() {
      try {
        const response = await fetch('/api/settings');
        if (response.ok) {
          const settings = await response.json();
          if (settings.customBackground) {
            document.getElementById('bgImage').src = settings.customBackground;
          }
        }
      } catch (error) {
        console.log('使用默认背景');
      }
    }

    loadSettings();
    loadPost();
  </script>
</body>
</html>
